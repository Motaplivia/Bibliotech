{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="section-title">Dashboard</h1>
    </div>

    <!-- Cards Informativos -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-secondary">
                <div class="stat-card bg-white">
                    <div class="stat-info">
                        <p class="text-secondary mb-1">Empréstimos Ativos</p>
                        <h3 class="text-white">{{ emprestimos_ativos }}</h3>
                    </div>
                    <div class="stat-icon text-secondary">
                        <i class="fas fa-handshake"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-warning">
                <div class="stat-card bg-white">
                    <div class="stat-info">
                        <p class="text-warning mb-1">Empréstimos Atrasados</p>
                        <h3 class="text-danger">{{ emprestimos_atrasados }}</h3>
                    </div>
                    <div class="stat-icon text-warning">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-primary">
                <div class="stat-card bg-white">
                    <div class="stat-info">
                        <p class="text-primary mb-1">Total de Livros</p>
                        <h3 class="text-white">{{ total_livros }}</h3>
                    </div>
                    <div class="stat-icon text-primary">
                        <i class="fas fa-book"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-primary">
                <div class="stat-card bg-white">
                    <div class="stat-info">
                        <p class="text-primary mb-1">Categorias</p>
                        <h3 class="text-white">{{ total_categorias }}</h3>
                    </div>
                    <div class="stat-icon text-primary">
                        <i class="fas fa-folder"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row g-4">
        <div class="col-xl-8">
            <div class="card">
                <div class="card-header" style="background: var(--accent-color); color: var(--light-color);">
                    <h6 class="m-0 font-weight-bold text-white">Empréstimos por Mês</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="emprestimosChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="card">
                <div class="card-header" style="background: var(--accent-color); color: var(--light-color);">
                    <h6 class="m-0 font-weight-bold text-white">Categorias Populares</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="categoriasChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabelas -->
    <div class="row g-4 mt-4">
        <div class="col-xl-6">
            <div class="card">
                <div class="card-header" style="background: var(--accent-color); color: var(--light-color);">
                    <h6 class="m-0 font-weight-bold text-white">Livros Mais Emprestados</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Livro</th>
                                    <th>Empréstimos</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for i in range(livros_mais_emprestados.labels|length) %}
                                <tr>
                                    <td>{{ livros_mais_emprestados.labels[i] }}</td>
                                    <td>{{ livros_mais_emprestados.data[i] }}</td>
                                    <td>
                                        <span class="badge" style="background-color: var(--secondary-color);">Disponível</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-6">
            <div class="card">
                <div class="card-header" style="background: var(--secondary-color); color: var(--light-color);">
                    <h6 class="m-0 font-weight-bold text-white">Empréstimos Recentes</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Usuário</th>
                                    <th>Livro</th>
                                    <th>Data</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if emprestimos_recentes %}
                                {% for emprestimo in emprestimos_recentes %}
                                <tr>
                                    <td>{{ emprestimo.usuario.nome }}</td>
                                    <td>{{ emprestimo.livro.titulo }}</td>
                                    <td>{{ emprestimo.data_emprestimo.strftime('%d/%m/%Y') }}</td>
                                    <td>
                                        {% if emprestimo.atrasado %}
                                        <span class="badge" style="background-color: #dc3545;">
                                            <i class="fas fa-exclamation-circle me-1"></i>Atrasado
                                        </span>
                                        {% else %}
                                        <span class="badge" style="background-color: var(--secondary-color);">
                                            <i class="fas fa-check-circle me-1"></i>Em Dia
                                        </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">Nenhum empréstimo recente</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .table {
        font-size: 0.875rem;
    }

    .table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.025em;
    }

    .border-primary {
        border-width: 2px !important;
        border-color: var(--primary-color) !important;
    }

    .border-secondary {
        border-width: 2px !important;
        border-color: var(--secondary-color) !important;
    }

    .border-warning {
        border-width: 2px !important;
        border-color: var(--accent-color) !important;
    }

    .text-primary {
        color: var(--primary-color) !important;
    }

    .text-secondary {
        color: var(--secondary-color) !important;
    }

    .text-warning {
        color: var(--accent-color) !important;
    }

    .stat-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
    }

    .stat-icon {
        font-size: 2rem;
        opacity: 0.8;
    }

    .stat-info h3 {
        font-size: 1.75rem;
        font-weight: 600;
        margin: 0;
    }

    .stat-info p {
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
</style>

<script>
    // Dados dos gráficos - parseando os dados do template para JSON
    const dadosEmprestimos = JSON.parse('{{ grafico_emprestimos|tojson|safe }}');
    const dadosCategorias = JSON.parse('{{ categorias_populares|tojson|safe }}');

    // Gráfico de Empréstimos
    const emprestimosCtx = document.getElementById('emprestimosChart').getContext('2d');
    const emprestimosChart = new Chart(emprestimosCtx, {
        type: 'line',
        data: {
            labels: dadosEmprestimos.meses,
            datasets: [
                {
                    label: 'Empréstimos',
                    data: dadosEmprestimos.emprestimos,
                    borderColor: 'var(--primary-color)',
                    backgroundColor: 'rgba(60, 110, 113, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Devoluções',
                    data: dadosEmprestimos.devolucoes,
                    borderColor: 'var(--secondary-color)',
                    backgroundColor: 'rgba(40, 75, 99, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.parsed.y;
                            return `${label}: ${value} ${value === 1 ? 'livro' : 'livros'}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        drawBorder: false,
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                        stepSize: 1,
                        font: {
                            size: 11
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });

    // Gráfico de Categorias
    const categoriasCtx = document.getElementById('categoriasChart').getContext('2d');
    const categoriasChart = new Chart(categoriasCtx, {
        type: 'doughnut',
        data: {
            labels: dadosCategorias.labels,
            datasets: [{
                data: dadosCategorias.data,
                backgroundColor: [
                    'var(--primary-color)',
                    'var(--secondary-color)',
                    'var(--accent-color)',
                    '#2F4F4F',
                    '#3C6E71'
                ],
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '70%',
            animation: {
                animateRotate: true,
                animateScale: true,
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });

    // Adiciona atributos ARIA para acessibilidade
    document.getElementById('emprestimosChart').setAttribute('role', 'img');
    document.getElementById('emprestimosChart').setAttribute('aria-label', 'Gráfico de linha mostrando empréstimos e devoluções por mês');
    document.getElementById('categoriasChart').setAttribute('role', 'img');
    document.getElementById('categoriasChart').setAttribute('aria-label', 'Gráfico de rosca mostrando distribuição de empréstimos por categoria');
</script>
{% endblock %}
